# Руководство по настройке КриптоПро КриптоКипер

## Обзор

Этот документ содержит пошаговые инструкции по настройке интеграции с КриптоПро КриптоКипер для вашего приложения кофейни.

## Требования

### 1. Оборудование
- **КриптоПро КриптоКипер** - физическая касса
- **Сертификат** - цифровой сертификат для подписи документов
- **Интернет-соединение** - стабильное подключение к интернету
- **Компьютер** - для настройки и управления

### 2. Программное обеспечение
- **КриптоПро CSP** - криптографический провайдер
- **КриптоПро КриптоКипер ПО** - программное обеспечение кассы
- **Сертификат** - установленный в системе

## Настройка

### Шаг 1: Установка КриптоПро CSP

1. **Скачайте КриптоПро CSP** с официального сайта
2. **Установите** программное обеспечение
3. **Активируйте** лицензию
4. **Проверьте** установку через консоль управления

### Шаг 2: Настройка сертификата

1. **Получите сертификат** от удостоверяющего центра
2. **Установите сертификат** в хранилище Windows
3. **Запомните отпечаток** сертификата (thumbprint)
4. **Установите пароль** для сертификата

#### Получение отпечатка сертификата:
```powershell
# В PowerShell выполните:
Get-ChildItem -Path "Cert:\CurrentUser\My" | Select-Object Subject, Thumbprint
```

### Шаг 3: Настройка КриптоКипер

1. **Подключите кассу** к компьютеру
2. **Установите драйверы** кассы
3. **Настройте сетевое подключение** (IP адрес, порт)
4. **Проверьте связь** с кассой

### Шаг 4: Конфигурация приложения

Откройте файл `pos-config.js` и заполните следующие поля:

```javascript
const POS_CONFIG = {
    // Основные настройки кассы
    cashRegister: {
        id: 'YOUR_CASH_REGISTER_ID', // ID вашей кассы
        name: 'Art Coffee POS',
        location: 'Nicosia, Cyprus',
        serialNumber: 'YOUR_SERIAL_NUMBER', // Серийный номер
        model: 'CryptoKeeper',
        version: '1.0'
    },
    
    // API настройки
    api: {
        baseUrl: 'https://api.cryptopro.ru/v1', // URL API
        apiKey: 'YOUR_CRYPTOPRO_API_KEY', // API ключ
        timeout: 30000,
        retryAttempts: 3,
        
        // Настройки сертификата
        certificate: {
            thumbprint: 'YOUR_CERTIFICATE_THUMBPRINT', // Отпечаток
            password: 'YOUR_CERTIFICATE_PASSWORD' // Пароль
        },
        
        // Настройки подключения
        connection: {
            type: 'tcp',
            host: 'localhost', // IP кассы
            port: 8080 // Порт кассы
        }
    }
};
```

### Шаг 5: Получение API ключей

1. **Зарегистрируйтесь** в личном кабинете КриптоПро
2. **Создайте приложение** в разделе "API"
3. **Получите API ключ** для вашего приложения
4. **Настройте права доступа** для приложения

### Шаг 6: Тестирование

1. **Откройте** `test-pos.html` в браузере
2. **Заполните** все поля конфигурации
3. **Нажмите** "Обновить конфигурацию"
4. **Проверьте** подключение к кассе
5. **Протестируйте** создание чека

## Работа с кассой

### Открытие смены

```javascript
// Открыть смену
const result = await posSystem.openShift();
if (result.success) {
    console.log('Смена открыта:', result.shiftId);
}
```

### Создание чека

```javascript
// Создать чек
const orderData = {
    items: [
        { name: 'Эспрессо', price: 120, quantity: 1, category: 'coffee' }
    ],
    total: 120,
    customerInfo: {
        name: 'Иван Иванов',
        phone: '+357 99 123456',
        email: 'ivan@example.com'
    }
};

const receipt = await posSystem.createReceipt(orderData);
```

### Закрытие смены

```javascript
// Закрыть смену
const result = await posSystem.closeShift();
if (result.success) {
    console.log('Смена закрыта');
}
```

## Отчеты

### X-отчет (промежуточный)

```javascript
// Сгенерировать X-отчет
const xReport = await posSystem.getXReport();
if (xReport.success) {
    console.log('X-отчет:', xReport.report);
}
```

### Z-отчет (итоговый)

```javascript
// Сгенерировать Z-отчет
const zReport = await posSystem.getZReport();
if (zReport.success) {
    console.log('Z-отчет:', zReport.report);
}
```

## Безопасность

### Рекомендации

1. **Храните сертификаты** в безопасном месте
2. **Используйте HTTPS** для всех запросов
3. **Регулярно обновляйте** сертификаты
4. **Ведите логи** всех операций
5. **Ограничьте доступ** к API ключам

### Настройка переменных окружения

```bash
# Создайте файл .env
CRYPTOPRO_API_KEY=your_api_key_here
CRYPTOPRO_CASH_REGISTER_ID=your_cash_register_id
CRYPTOPRO_CERTIFICATE_THUMBPRINT=your_certificate_thumbprint
CRYPTOPRO_CERTIFICATE_PASSWORD=your_certificate_password
CRYPTOPRO_API_URL=https://api.cryptopro.ru/v1
```

## Устранение неполадок

### Частые проблемы

1. **Ошибка подключения к кассе**
   - Проверьте IP адрес и порт кассы
   - Убедитесь, что касса включена
   - Проверьте сетевые настройки

2. **Ошибка сертификата**
   - Проверьте отпечаток сертификата
   - Убедитесь, что сертификат не истек
   - Проверьте пароль сертификата

3. **Ошибка API**
   - Проверьте API ключ
   - Убедитесь в правильности URL
   - Проверьте лимиты API

### Логи для отладки

```javascript
// Включите подробное логирование
console.log('CryptoPro Debug Mode:', true);

// Проверьте статус кассы
const status = await posSystem.getCashRegisterStatus();
console.log('Cash register status:', status);
```

## Поддержка

### Контакты
- **Техническая поддержка КриптоПро**: support@cryptopro.ru
- **Документация**: https://docs.cryptopro.ru
- **Форум**: https://forum.cryptopro.ru

### Полезные ссылки
- [КриптоПро КриптоКипер](https://www.cryptopro.ru/products/cryptokeeper)
- [КриптоПро CSP](https://www.cryptopro.ru/products/csp)
- [API документация](https://api.cryptopro.ru/docs)

## Обновления

Система поддерживает автоматические обновления:
- API версии
- Налоговые ставки
- Форматы чеков
- Безопасность

---

**Важно**: Всегда тестируйте изменения в тестовом режиме перед переходом в продакшен!

## Дополнительные настройки

### Настройка сети

1. **Статический IP** для кассы
2. **Порт 8080** для API
3. **Firewall** - разрешить подключения
4. **VPN** для удаленного доступа

### Резервное копирование

1. **Конфигурация** - сохраните настройки
2. **Сертификаты** - экспортируйте с паролем
3. **Логи** - регулярно архивируйте
4. **База данных** - создавайте бэкапы

### Мониторинг

1. **Статус кассы** - проверяйте регулярно
2. **Соединение** - мониторьте стабильность
3. **Ошибки** - настройте уведомления
4. **Производительность** - отслеживайте метрики
